#!/usr/bin/env python3
"""
INICIO.PY - Orquestador Principal del Sistema de Agentes
===========================================================

DESCRIPCI√ìN:
    Archivo principal que organiza y ejecuta todas las funciones del sistema
    con un men√∫ interactivo mejorado.

FUNCIONALIDADES:
    - Men√∫ principal interactivo
    - Inicio opcional del servidor MCP
    - Gesti√≥n interactiva de agentes
    - Selecci√≥n y conversaci√≥n con agentes
    - Manejo robusto de errores y excepciones
"""

import os
import sys
import time
import subprocess
import signal
import json
from pathlib import Path
from dotenv import load_dotenv

# Configurar encoding UTF-8
if sys.platform.startswith('win'):
    import locale
    import codecs
    sys.stdout = codecs.getwriter('utf-8')(sys.stdout.buffer)
    sys.stderr = codecs.getwriter('utf-8')(sys.stderr.buffer)
else:
    os.environ['PYTHONIOENCODING'] = 'utf-8'

# Cargar variables de entorno
load_dotenv(encoding='utf-8')

class OrquestadorInicio:
    """
    Clase principal que orquesta la ejecuci√≥n de todas las funciones del sistema.
    """
    
    def __init__(self):
        """
        Inicializa el orquestador con configuraci√≥n b√°sica.
        """
        self.mcp_proceso = None
        self.mcp_activo = False
        self.directorio_trabajo = Path(__file__).parent
        self.archivo_mcp = self.directorio_trabajo / "chuck_norris_server.py"
        
        # Configurar manejo de se√±ales para limpieza
        signal.signal(signal.SIGINT, self._manejar_interrupcion)
        signal.signal(signal.SIGTERM, self._manejar_interrupcion)
    
    def _manejar_interrupcion(self, signum, frame):
        """
        Maneja interrupciones del sistema para limpieza ordenada.
        """
        print("\nüõë Interrupci√≥n detectada, realizando limpieza...")
        self._detener_mcp()
        print("üëã ¬°Hasta luego!")
        sys.exit(0)
    
    def mostrar_bienvenida(self):
        """
        Muestra el banner de bienvenida del sistema.
        """
        print("\n" + "=" * 80)
        print("üöÄ SISTEMA DE AGENTES AZURE AI FOUNDRY")
        print("=" * 80)
        print("ü§ñ Bienvenido al sistema integrado de agentes conversacionales")
        print("üí´ Este sistema te permitir√° gestionar y conversar con agentes de IA")
        print("=" * 80)
    
    def validar_entorno(self):
        """
        Valida que el entorno est√© correctamente configurado.
        """
        # Variables de entorno requeridas
        variables_requeridas = [
            "PROJECT_ENDPOINT",
            "MODEL_DEPLOYMENT_NAME"
        ]
        
        variables_faltantes = []
        for variable in variables_requeridas:
            if not os.environ.get(variable):
                variables_faltantes.append(variable)
        
        if variables_faltantes:
            print("‚ùå Variables de entorno faltantes:")
            for variable in variables_faltantes:
                print(f"   - {variable}")
            print("\nüí° Configura estas variables en tu archivo .env")
            return False
        
        # Validar archivos necesarios
        archivos_requeridos = [
            "chuck_norris_server.py",
            "crear_agente.py", 
            "conversar_agente.py"
        ]
        
        archivos_faltantes = []
        for archivo in archivos_requeridos:
            if not (self.directorio_trabajo / archivo).exists():
                archivos_faltantes.append(archivo)
        
        if archivos_faltantes:
            print("‚ùå Archivos faltantes:")
            for archivo in archivos_faltantes:
                print(f"   - {archivo}")
            return False
        
        return True
    
    def obtener_opcion_usuario(self, mensaje, opciones_validas, mostrar_opciones=True):
        """
        Obtiene una opci√≥n v√°lida del usuario.
        """
        while True:
            if mostrar_opciones:
                print(f"\n{mensaje}")
            try:
                opcion = input("üëâ Selecciona una opci√≥n: ").strip()
                
                if opcion in opciones_validas:
                    return opcion
                else:
                    print(f"‚ùå Opci√≥n no v√°lida. Por favor selecciona: {', '.join(opciones_validas)}")
                    
            except KeyboardInterrupt:
                print("\n‚ùå Operaci√≥n cancelada")
                return None
            except EOFError:
                print("\n‚ùå Entrada finalizada")
                return None
    
    def mostrar_menu_principal(self):
        """
        Muestra el men√∫ principal del sistema.
        """
        estado_mcp = "üü¢ ACTIVO" if self.mcp_activo else "üî¥ INACTIVO"
        
        print(f"\nüìã MEN√ö PRINCIPAL")
        print(f"   Estado MCP: {estado_mcp}")
        print("=" * 50)
        print("1. üîß Gestionar Agentes")
        print("2. üí¨ Conversar con Agentes")
        print("3. üöÄ Iniciar/Detener Servidor MCP")
        print("4. üìä Ver Estado del Sistema")
        print("5. ‚ùå Salir")
        
        return self.obtener_opcion_usuario("¬øQu√© deseas hacer?", ["1", "2", "3", "4", "5"], False)
    
    def iniciar_mcp(self):
        """
        Inicia el servidor MCP (Model Context Protocol).
        """
        if self.mcp_activo:
            print("‚ö†Ô∏è El servidor MCP ya est√° activo")
            return True
            
        print("\nüöÄ Iniciando servidor MCP...")
        
        if not self.archivo_mcp.exists():
            print(f"‚ùå No se encontr√≥ el archivo {self.archivo_mcp}")
            return False
        
        try:
            print(f"üìÅ Ejecutando: {self.archivo_mcp}")
            
            # Iniciar el servidor en modo background
            self.mcp_proceso = subprocess.Popen(
                [sys.executable, str(self.archivo_mcp)],
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
                text=True,
                cwd=str(self.directorio_trabajo)
            )
            
            # Dar tiempo para que el servidor se inicie
            time.sleep(2)
            
            # Verificar que el proceso siga corriendo
            if self.mcp_proceso.poll() is None:
                self.mcp_activo = True
                print("‚úÖ Servidor MCP iniciado correctamente")
                print(f"üÜî PID del proceso: {self.mcp_proceso.pid}")
                return True
            else:
                # El proceso termin√≥, obtener error
                stdout, stderr = self.mcp_proceso.communicate()
                print("‚ùå Error al iniciar servidor MCP:")
                if stderr:
                    print(f"Error: {stderr}")
                if stdout:
                    print(f"Salida: {stdout}")
                return False
                
        except Exception as e:
            print(f"‚ùå Error al iniciar servidor MCP: {e}")
            return False
    
    def detener_mcp(self):
        """
        Detiene el servidor MCP.
        """
        if not self.mcp_activo:
            print("‚ö†Ô∏è El servidor MCP no est√° activo")
            return True
            
        return self._detener_mcp()
    
    def _detener_mcp(self):
        """
        Detiene el servidor MCP de manera ordenada.
        """
        if self.mcp_proceso and self.mcp_proceso.poll() is None:
            print("üõë Deteniendo servidor MCP...")
            try:
                self.mcp_proceso.terminate()
                self.mcp_proceso.wait(timeout=5)
                self.mcp_activo = False
                print("‚úÖ Servidor MCP detenido correctamente")
                return True
            except subprocess.TimeoutExpired:
                print("‚ö†Ô∏è Forzando cierre del servidor MCP...")
                self.mcp_proceso.kill()
                self.mcp_proceso.wait()
                self.mcp_activo = False
                print("‚úÖ Servidor MCP cerrado forzosamente")
                return True
            except Exception as e:
                print(f"‚ö†Ô∏è Error al detener servidor MCP: {e}")
                return False
        else:
            self.mcp_activo = False
            return True
    
    def gestionar_mcp(self):
        """
        Gestiona el servidor MCP (iniciar/detener).
        """
        if self.mcp_activo:
            print("\nüü¢ El servidor MCP est√° actualmente ACTIVO")
            opcion = self.obtener_opcion_usuario(
                "¬øQu√© deseas hacer?\n1. Detener servidor\n2. Volver al men√∫ principal",
                ["1", "2"]
            )
            if opcion == "1":
                self.detener_mcp()
            # Opci√≥n 2 simplemente regresa
        else:
            print("\nüî¥ El servidor MCP est√° actualmente INACTIVO")
            opcion = self.obtener_opcion_usuario(
                "¬øQu√© deseas hacer?\n1. Iniciar servidor\n2. Volver al men√∫ principal",
                ["1", "2"]
            )
            if opcion == "1":
                self.iniciar_mcp()
            # Opci√≥n 2 simplemente regresa
    
    def gestionar_agentes(self):
        """
        Ejecuta la gesti√≥n de agentes.
        """
        print("\nü§ñ GESTI√ìN DE AGENTES")
        print("=" * 30)
        
        try:
            # Importar y ejecutar el gestor de agentes
            sys.path.insert(0, str(self.directorio_trabajo))
            from crear_agente import GestorAgente
            
            gestor = GestorAgente()
            
            # Mostrar agentes existentes
            agentes_existentes = gestor.obtener_agentes_existentes()
            
            if agentes_existentes:
                print(f"üìã Agentes existentes ({len(agentes_existentes)}):")
                for i, agente in enumerate(agentes_existentes, 1):
                    print(f"   {i}. {agente['nombre']} ({agente['tipo']})")
                    print(f"      ID: {agente['id']}")
                    fecha = agente.get('fecha_creacion', 'N/A')
                    if len(fecha) > 19:  # Truncar fecha si es muy larga
                        fecha = fecha[:19]
                    print(f"      Creado: {fecha}")
                
                opcion = self.obtener_opcion_usuario(
                    "¬øQu√© deseas hacer?\n1. Usar agentes existentes\n2. Crear nuevo agente\n3. Actualizar agente existente\n4. Eliminar agente\n5. Volver al men√∫ principal",
                    ["1", "2", "3", "4", "5"]
                )
                
                if opcion == "1":
                    print("‚úÖ Continuando con agentes existentes")
                    return True
                elif opcion == "2":
                    print("\nüîß Creando nuevo agente...")
                    agent_id = gestor.crear_agente()
                    if agent_id:
                        print("‚úÖ Nuevo agente creado exitosamente")
                        return True
                    else:
                        print("‚ùå No se pudo crear el agente")
                        return False
                elif opcion == "3":
                    print("\nüîß Actualizando agente...")
                    if gestor.actualizar_agente():
                        print("‚úÖ Agente actualizado exitosamente")
                        return True
                    else:
                        print("‚ùå No se pudo actualizar el agente")
                        return False
                elif opcion == "4":
                    # Eliminar agente
                    print("\nSelecciona el agente a eliminar:")
                    for i, agente in enumerate(agentes_existentes, 1):
                        print(f"{i}. {agente['nombre']}")
                    
                    opciones_validas = [str(i) for i in range(1, len(agentes_existentes) + 1)]
                    opciones_validas.append("0")  # Para cancelar
                    
                    indice_str = self.obtener_opcion_usuario(
                        "Ingresa el n√∫mero del agente (0 para cancelar):",
                        opciones_validas,
                        False
                    )
                    
                    if indice_str == "0" or indice_str is None:
                        print("‚ùå Cancelado")
                        return True
                    
                    indice = int(indice_str) - 1
                    agente_a_eliminar = agentes_existentes[indice]
                    
                    confirmacion = self.obtener_opcion_usuario(
                        f"¬øConfirmas eliminar '{agente_a_eliminar['nombre']}'?\n1. S√≠, eliminar\n2. No, cancelar",
                        ["1", "2"]
                    )
                    
                    if confirmacion == "1":
                        gestor.limpiar_agente(agente_a_eliminar['id'])
                        print("‚úÖ Agente eliminado")
                        return True
                    else:
                        print("‚ùå Cancelado")
                        return True
                elif opcion == "5":
                    return True
                else:
                    return True
            else:
                # No hay agentes existentes, crear uno nuevo
                print("üì≠ No se encontraron agentes existentes")
                opcion = self.obtener_opcion_usuario(
                    "¬øQu√© deseas hacer?\n1. Crear primer agente\n2. Volver al men√∫ principal",
                    ["1", "2"]
                )
                
                if opcion == "1":
                    print("üîß Creando primer agente...")
                    agent_id = gestor.crear_agente()
                    if agent_id:
                        print("‚úÖ Primer agente creado exitosamente")
                        return True
                    else:
                        print("‚ùå No se pudo crear el agente")
                        return False
                else:
                    return True
                    
        except ImportError as e:
            print(f"‚ùå Error al importar gestor de agentes: {e}")
            return False
        except Exception as e:
            print(f"‚ùå Error en gesti√≥n de agentes: {e}")
            return False
    
    def conversar_con_agentes(self):
        """
        Inicia la conversaci√≥n con agentes.
        """
        print("\nüí¨ CONVERSACI√ìN CON AGENTES")
        print("=" * 35)
        
        try:
            # Verificar si hay agentes disponibles
            agentes_json = os.environ.get("AGENTS_DATA", "[]")
            agentes = json.loads(agentes_json)
            
            if not agentes:
                print("‚ùå No hay agentes disponibles para conversar")
                opcion = self.obtener_opcion_usuario(
                    "¬øQu√© deseas hacer?\n1. Ir a gesti√≥n de agentes\n2. Volver al men√∫ principal",
                    ["1", "2"]
                )
                
                if opcion == "1":
                    return self.gestionar_agentes()
                else:
                    return True
            
            print(f"üìã Agentes disponibles ({len(agentes)}):")
            for i, agente in enumerate(agentes, 1):
                print(f"   {i}. {agente['nombre']}")
            
            opcion = self.obtener_opcion_usuario(
                "¬øQu√© deseas hacer?\n1. Iniciar conversaci√≥n\n2. Volver al men√∫ principal",
                ["1", "2"]
            )
            
            if opcion == "2":
                return True
            
            print("\nüöÄ Iniciando sistema de conversaci√≥n...")
            print("üí° Usa 'salir', 'quit' o 'exit' para terminar la conversaci√≥n")
            
            # Ejecutar el sistema de conversaci√≥n
            archivo_conversacion = self.directorio_trabajo / "conversar_agente.py"
            
            if not archivo_conversacion.exists():
                print(f"‚ùå No se encontr√≥ {archivo_conversacion}")
                return False
            
            print("\nüéØ Iniciando interfaz de conversaci√≥n...")
            
            # Ejecutar el script de conversaci√≥n
            resultado = subprocess.run(
                [sys.executable, str(archivo_conversacion)],
                cwd=str(self.directorio_trabajo)
            )
            
            if resultado.returncode == 0:
                print("\n‚úÖ Sesi√≥n de conversaci√≥n completada")
                return True
            else:
                print(f"\n‚ö†Ô∏è La conversaci√≥n termin√≥ con c√≥digo: {resultado.returncode}")
                return True
                
        except json.JSONDecodeError:
            print("‚ùå Error al leer datos de agentes")
            return False
        except KeyboardInterrupt:
            print("\n‚ùå Conversaci√≥n cancelada por el usuario")
            return True
        except Exception as e:
            print(f"‚ùå Error al iniciar conversaci√≥n: {e}")
            return False
    
    def mostrar_estado_sistema(self):
        """
        Muestra el estado actual del sistema.
        """
        print("\nüìä ESTADO DEL SISTEMA")
        print("=" * 30)
        
        # Estado MCP
        estado_mcp = "üü¢ ACTIVO" if self.mcp_activo else "üî¥ INACTIVO"
        print(f"Servidor MCP: {estado_mcp}")
        
        if self.mcp_activo and self.mcp_proceso:
            print(f"PID del proceso: {self.mcp_proceso.pid}")
        
        # Estado de agentes
        try:
            agentes_json = os.environ.get("AGENTS_DATA", "[]")
            agentes = json.loads(agentes_json)
            print(f"Agentes disponibles: {len(agentes)}")
            
            if agentes:
                print("Lista de agentes:")
                for i, agente in enumerate(agentes, 1):
                    print(f"   {i}. {agente['nombre']} ({agente['tipo']})")
        except json.JSONDecodeError:
            print("Agentes disponibles: Error al leer datos")
        
        # Variables de entorno
        print(f"\nConfiguraci√≥n:")
        print(f"   PROJECT_ENDPOINT: {'‚úÖ Configurado' if os.environ.get('PROJECT_ENDPOINT') else '‚ùå No configurado'}")
        print(f"   MODEL_DEPLOYMENT_NAME: {'‚úÖ Configurado' if os.environ.get('MODEL_DEPLOYMENT_NAME') else '‚ùå No configurado'}")
        
        input("\nüì± Presiona Enter para continuar...")
    
    def ejecutar(self):
        """
        M√©todo principal que ejecuta el men√∫ interactivo del sistema.
        """
        try:
            # Mostrar bienvenida
            self.mostrar_bienvenida()
            
            # Validar entorno
            if not self.validar_entorno():
                print("\n‚ùå Validaci√≥n de entorno fall√≥.")
                print("üí° Por favor configura las variables de entorno necesarias y vuelve a intentar.")
                return
            
            print("‚úÖ Entorno validado correctamente")
            
            # Bucle principal del men√∫
            while True:
                opcion = self.mostrar_menu_principal()
                
                if opcion is None:  # Usuario cancel√≥
                    break
                elif opcion == "1":
                    self.gestionar_agentes()
                elif opcion == "2":
                    self.conversar_con_agentes()
                elif opcion == "3":
                    self.gestionar_mcp()
                elif opcion == "4":
                    self.mostrar_estado_sistema()
                elif opcion == "5":
                    print("\nüëã ¬°Gracias por usar el Sistema de Agentes Azure AI Foundry!")
                    break
                else:
                    print("‚ùå Opci√≥n no v√°lida")
            
        except KeyboardInterrupt:
            print("\nüõë Ejecuci√≥n interrumpida por el usuario")
        except Exception as e:
            print(f"\n‚ùå Error inesperado: {e}")
        finally:
            # Limpieza final
            self._detener_mcp()

def main():
    """
    Funci√≥n principal del programa.
    """
    try:
        orquestador = OrquestadorInicio()
        orquestador.ejecutar()
    except Exception as e:
        print(f"‚ùå Error cr√≠tico: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()